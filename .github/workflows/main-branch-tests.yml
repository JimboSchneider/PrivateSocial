name: Main Branch Test Report

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  NODE_VERSION: '20.x'

jobs:
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: PrivateSocial.Web.React/package-lock.json

    - name: Restore .NET dependencies
      run: dotnet restore

    - name: Build .NET solution
      run: dotnet build --no-restore --configuration Release

    - name: Run .NET tests with coverage
      run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage"

    - name: Install Node dependencies
      working-directory: ./PrivateSocial.Web.React
      run: npm ci

    - name: Run Frontend tests with coverage
      id: frontend-tests
      working-directory: ./PrivateSocial.Web.React
      run: |
        npm run test:coverage -- --run
        echo "result=success" >> $GITHUB_OUTPUT
      # If tests fail, the step exits non-zero, so result won't be set
      # We use the step outcome in the summary instead

    - name: Generate test summary
      if: always()
      run: |
        echo "# Test Summary - Main Branch" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Backend Tests (.NET)" >> $GITHUB_STEP_SUMMARY

        # Count test results from TRX files
        TOTAL_TESTS=$(find . -name "*.trx" -exec grep -o "total=\"[0-9]*\"" {} \; | grep -o "[0-9]*" | head -1 || echo "0")
        PASSED_TESTS=$(find . -name "*.trx" -exec grep -o "passed=\"[0-9]*\"" {} \; | grep -o "[0-9]*" | head -1 || echo "0")
        FAILED_TESTS=$(find . -name "*.trx" -exec grep -o "failed=\"[0-9]*\"" {} \; | grep -o "[0-9]*" | head -1 || echo "0")

        echo "- Total Tests: $TOTAL_TESTS" >> $GITHUB_STEP_SUMMARY
        echo "- Passed: ‚úÖ $PASSED_TESTS" >> $GITHUB_STEP_SUMMARY
        echo "- Failed: ‚ùå $FAILED_TESTS" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## Frontend Tests (React)" >> $GITHUB_STEP_SUMMARY
        FRONTEND_OUTCOME="${{ steps.frontend-tests.outcome }}"
        if [ "$FRONTEND_OUTCOME" = "success" ]; then
          echo "- ‚úÖ All frontend tests passing" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ‚ùå Frontend tests failed" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## Overall Status" >> $GITHUB_STEP_SUMMARY
        if [ "$FAILED_TESTS" -eq "0" ] && [ "$FRONTEND_OUTCOME" = "success" ]; then
          echo "‚úÖ All tests passing on main branch!" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚ö†Ô∏è Some tests failed - immediate attention required!" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Last updated: $(date)" >> $GITHUB_STEP_SUMMARY

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: main-branch-test-results
        path: |
          **/TestResults/*.trx
          **/coverage/
          PrivateSocial.Web.React/coverage/
        retention-days: 90

    - name: Upload coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          **/coverage.cobertura.xml
          PrivateSocial.Web.React/coverage/
        retention-days: 90

    - name: Comment test results on latest commit
      if: always()
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const path = require('path');

          // Recursively find TRX files
          function findFiles(dir, pattern) {
            const results = [];
            try {
              const entries = fs.readdirSync(dir, { withFileTypes: true });
              for (const entry of entries) {
                const fullPath = path.join(dir, entry.name);
                if (entry.isDirectory() && entry.name !== 'node_modules') {
                  results.push(...findFiles(fullPath, pattern));
                } else if (entry.isFile() && entry.name.endsWith(pattern)) {
                  results.push(fullPath);
                }
              }
            } catch (e) {
              // Skip directories we can't read
            }
            return results;
          }

          let backendTotal = 0;
          let backendPassed = 0;
          let backendFailed = 0;

          const trxFiles = findFiles('.', '.trx');
          for (const trxFile of trxFiles) {
            try {
              const content = fs.readFileSync(trxFile, 'utf-8');
              const totalMatch = content.match(/total="(\d+)"/);
              const passedMatch = content.match(/passed="(\d+)"/);
              const failedMatch = content.match(/failed="(\d+)"/);
              if (totalMatch) backendTotal += parseInt(totalMatch[1], 10);
              if (passedMatch) backendPassed += parseInt(passedMatch[1], 10);
              if (failedMatch) backendFailed += parseInt(failedMatch[1], 10);
            } catch (e) {
              console.log(`Could not read ${trxFile}: ${e.message}`);
            }
          }

          const frontendOutcome = '${{ steps.frontend-tests.outcome }}';
          const frontendStatus = frontendOutcome === 'success'
            ? '‚úÖ All React tests passing'
            : '‚ùå Frontend tests failed';

          const backendStatus = backendFailed === 0
            ? `‚úÖ ${backendPassed}/${backendTotal} .NET tests passing`
            : `‚ùå ${backendFailed}/${backendTotal} .NET tests failed`;

          const allPassing = backendFailed === 0 && frontendOutcome === 'success';
          const overallStatus = allPassing
            ? '‚úÖ **Main branch is healthy!**'
            : '‚ö†Ô∏è **Some tests failed - immediate attention required!**';

          const message = [
            '## üß™ Test Report - Main Branch',
            '',
            '### Backend Tests',
            backendStatus,
            '',
            '### Frontend Tests',
            frontendStatus,
            '',
            '### Overall Status',
            overallStatus,
            '',
            `_Last tested: ${new Date().toISOString()}_`
          ].join('\n');

          await github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: message
          });
